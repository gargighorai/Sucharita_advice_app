{% extends "base.html" %}
{% block title %}Give Advice{% endblock %}

{% block content %}
<div class="container">
  <h3 class="mb-4">Prescribe Advice</h3>

  <form method="POST" action="{{ url_for('give_advice') }}" id="adviceForm">
    <div class="mb-3">
      <label class="form-label">Patient Name</label>
      <input type="text" name="patient_name" class="form-control" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Drugs</label>
      <select name="drugs" multiple class="form-select select2" required>
        {% for drug in drugs %}
          <option value="{{ drug.name }}">{{ drug.name }}</option>
        {% endfor %}
      </select>
      <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
    </div>

    <div class="mb-3">
      <label class="form-label">Advice</label>
      <textarea name="advice" class="form-control" rows="3" required></textarea>
    </div>

    <div class="d-flex justify-content-between">
      <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#cancelModal">
        Cancel
      </button>
      <button type="submit" class="btn btn-success">Submit Advice</button>
    </div>
  </form>
</div>

<!-- Cancel Confirmation Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-warning">
      <div class="modal-header bg-warning">
        <h5 class="modal-title" id="cancelModalLabel">Confirm Cancel</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Do you really want to cancel? All entered data will be lost.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-danger">Yes, Cancel</a>
      </div>
    </div>
  </div>
</div>

<!-- Required JS and CSS for Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
window.addEventListener('DOMContentLoaded', function () {
  $('#drugSelect').select2({
    placeholder: "Select drugs",
    allowClear: true,
    width: '100%'
  });
});
$(document).ready(function () {
  $('#drugSelect').select2({
    placeholder: 'Search and select drugs',
    width: '100%',
    ajax: {
      url: "{{ url_for('autocomplete_drugs') }}",
      dataType: 'json',
      delay: 250,
      processResults: function (data) {
        return {
          results: data.map(function (item) {
            return { id: item.name, text: item.name };
          })
        };
      },
      cache: true
    }
  });
});
</script>
{% endblock %}
